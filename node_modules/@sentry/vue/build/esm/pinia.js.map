{"version":3,"file":"pinia.js","sources":["../../src/pinia.ts"],"sourcesContent":["import { addBreadcrumb, addNonEnumerableProperty, getClient, getCurrentScope, getGlobalScope } from '@sentry/core';\nimport type { Ref } from 'vue';\n\n// Inline Pinia types\ntype StateTree = Record<string | number | symbol, any>;\ntype PiniaPlugin = (context: {\n  store: {\n    $id: string;\n    $state: unknown;\n    $onAction: (callback: (context: { name: string; after: (callback: () => void) => void }) => void) => void;\n  };\n  pinia: { state: Ref<Record<string, StateTree>> };\n}) => void;\n\ntype SentryPiniaPluginOptions = {\n  attachPiniaState?: boolean;\n  addBreadcrumbs?: boolean;\n  actionTransformer?: (action: string) => any;\n  stateTransformer?: (state: Record<string, unknown>) => any;\n};\n\nexport const createSentryPiniaPlugin: (options?: SentryPiniaPluginOptions) => PiniaPlugin = (\n  options: SentryPiniaPluginOptions = {\n    attachPiniaState: true,\n    addBreadcrumbs: true,\n    actionTransformer: action => action,\n    stateTransformer: state => state,\n  },\n) => {\n  const plugin: PiniaPlugin = ({ store, pinia }) => {\n    const getAllStoreStates = (): Record<string, unknown> => {\n      const states: Record<string, unknown> = {};\n\n      Object.keys(pinia.state.value).forEach(storeId => {\n        states[storeId] = pinia.state.value[storeId];\n      });\n\n      return states;\n    };\n\n    options.attachPiniaState !== false &&\n      getGlobalScope().addEventProcessor((event, hint) => {\n        try {\n          // Get current timestamp in hh:mm:ss\n          const timestamp = new Date().toTimeString().split(' ')[0];\n          const filename = `pinia_state_all_stores_${timestamp}.json`;\n\n          // event processor runs for each pinia store - attachment should only be added once per event\n          const hasExistingPiniaStateAttachment = hint.attachments?.some(attachment =>\n            attachment.filename.startsWith('pinia_state_all_stores_'),\n          );\n\n          if (!hasExistingPiniaStateAttachment) {\n            hint.attachments = [\n              ...(hint.attachments || []),\n              {\n                filename,\n                data: JSON.stringify(getAllStoreStates()),\n              },\n            ];\n          }\n        } catch (_) {\n          // empty\n        }\n\n        return event;\n      });\n\n    store.$onAction(context => {\n      context.after(() => {\n        const transformedActionName = options.actionTransformer\n          ? options.actionTransformer(context.name)\n          : context.name;\n\n        if (\n          typeof transformedActionName !== 'undefined' &&\n          transformedActionName !== null &&\n          options.addBreadcrumbs !== false\n        ) {\n          addBreadcrumb({\n            category: 'pinia.action',\n            message: `Store: ${store.$id} | Action: ${transformedActionName}`,\n            level: 'info',\n          });\n        }\n\n        /* Set latest state of all stores to scope */\n        const allStates = getAllStoreStates();\n        const transformedState = options.stateTransformer ? options.stateTransformer(allStates) : allStates;\n        const scope = getCurrentScope();\n        const currentState = scope.getScopeData().contexts.state;\n\n        if (typeof transformedState !== 'undefined' && transformedState !== null) {\n          const client = getClient();\n          const options = client?.getOptions();\n          const normalizationDepth = options?.normalizeDepth || 3; // default state normalization depth to 3\n          const piniaStateContext = { type: 'pinia', value: transformedState };\n\n          const newState = {\n            ...(currentState || {}),\n            state: piniaStateContext,\n          };\n\n          addNonEnumerableProperty(\n            newState,\n            '__sentry_override_normalization_depth__',\n            3 + // 3 layers for `state.value.transformedState\n              normalizationDepth, // rest for the actual state\n          );\n\n          scope.setContext('state', newState);\n        } else {\n          scope.setContext('state', {\n            ...(currentState || {}),\n            state: { type: 'pinia', value: 'undefined' },\n          });\n        }\n      });\n    });\n  };\n\n  return plugin;\n};\n"],"names":[],"mappings":"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"}