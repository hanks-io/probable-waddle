/*!
  * version-polling v1.2.6
  * (c) 2023 JoeshuTT
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).VersionPolling={})}(this,(function(t){"use strict";function e(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function i(){let t,e=null;return self.onmessage=i=>{let n=i.data.code;t=Object.assign({},t,i.data.data);const{htmlFileUrl:o,lastEtag:s,appETagKey:l,pollingInterval:a,silentPollingInterval:r}=t,c=()=>{fetch(o,{method:"HEAD",cache:"no-cache"}).then((t=>{if(200!==Number(t.status))return;const e=t.headers.get("etag").replace(/W\//, '');s!==e&&self.postMessage({appETagKey:l,lastEtag:s,etag:e})}))};"pause"===n?e&&(clearInterval(e),e=null):(c(),r||(e=setInterval(c,a)))},self}let n;const o={appETagKey:"__APP_ETAG__",pollingInterval:3e5,htmlFileUrl:`${location.origin}${location.pathname}`,silent:!1,silentPollingInterval:!1,silentPageVisibility:!1,forceUpdate:!1};let s=!1;function l(){"visible"===document.visibilityState?n.postMessage({code:"resume"}):n.postMessage({code:"pause"})}class a{constructor(t){e(this,"options",void 0),e(this,"appEtag",""),this.options=Object.assign({},o,t),this.init()}async init(){const{htmlFileUrl:t}=this.options;if(!t)throw new Error("[version-polling]: htmlFileUrl is required");const e=await fetch(t,{method:"HEAD",cache:"no-cache"});if(200!==Number(e.status))throw new Error(`[version-polling]: status is ${e.status}`);const i=e.headers.get("etag").replace(/W\//, '');if(null==i)throw new Error("[version-polling]: etag is null");this.appEtag=i,localStorage.setItem(`${this.options.appETagKey}`,i),this.start()}start(){const{appETagKey:t,pollingInterval:e,htmlFileUrl:o,silent:a,silentPollingInterval:r,silentPageVisibility:c}=this.options;a||(n=function(t){const e=new Blob(["("+t.toString()+")()"]),i=window.URL.createObjectURL(e),n=new Worker(i);return window.URL.revokeObjectURL(i),n}(i),n.postMessage({code:"start",data:{appETagKey:t,pollingInterval:e,htmlFileUrl:o,silentPollingInterval:r,lastEtag:this.appEtag}}),n.onmessage=t=>{const{lastEtag:e,etag:i}=t.data;e!==i&&(this.stop(),this.options.onUpdate?.(this))},c||s||(document.addEventListener("visibilitychange",l),s=!0))}stop(){n&&(n.terminate(),s&&(document.removeEventListener("visibilitychange",l),s=!1))}onRefresh(){window.location.reload()}onCancel(){this.options.forceUpdate&&this.start()}}t.VersionPolling=a,t.createVersionPolling=function(t){return new a(t)}}));
